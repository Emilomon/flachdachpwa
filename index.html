<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Wir zwei ‚Äì Check-in App</title>
  <meta name="format-detection" content="telephone=no" />

  <!-- PWA (Android/General) -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0d1025" />

  <!-- PWA (Apple/iOS) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png" />

  <style>
    :root{
      --bg:#0d1025;--panel:#151a32;--ink:#e9edff;--muted:#a8b2d6;--accent:#7dd6ff;--accent-2:#b3ffdc;--card:#1b2040;--outline:#2c3358;--shadow:0 18px 56px rgba(8,12,32,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{background:radial-gradient(circle at 20% 20%,rgba(125,214,255,.15),transparent 28%),radial-gradient(circle at 80% 0%,rgba(179,255,220,.16),transparent 30%),var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;padding:12px;display:flex;flex-direction:column;align-items:center;min-height:100vh;gap:14px;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:rgba(255,255,255,0)}
    @supports(padding:max(0px)){
      body{padding-top:max(12px,env(safe-area-inset-top));padding-right:max(12px,env(safe-area-inset-right));padding-bottom:max(12px,env(safe-area-inset-bottom));padding-left:max(12px,env(safe-area-inset-left))}
    }
    .shell{width:min(1200px,98vw);margin:auto;display:flex;flex-direction:column;gap:14px}
    .hero{background:linear-gradient(135deg,rgba(125,214,255,.24),rgba(179,255,220,.14));border:1px solid rgba(255,255,255,.1);border-radius:22px;padding:18px 18px 16px;box-shadow:var(--shadow)}
    header{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;align-items:flex-start}
    h1{margin:0;font-size:clamp(22px,4vw,30px);letter-spacing:-0.3px}
    p{margin:0;color:var(--muted);line-height:1.5}
    .eyebrow{font-size:12px;letter-spacing:1px;text-transform:uppercase;color:#9fd9ff;margin-bottom:4px;font-weight:700}
    .badges{display:flex;flex-wrap:wrap;gap:8px}
    .badge{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:8px 10px;font-variant-numeric:tabular-nums;color:var(--ink);display:flex;align-items:center;gap:6px}
    .layout{margin-top:14px;display:flex;flex-direction:column;gap:14px}
    .panel{background:var(--card);border:1px solid var(--outline);border-radius:18px;padding:16px;display:flex;flex-direction:column;gap:14px;box-shadow:var(--shadow)}
    label{font-weight:700;color:var(--ink);display:block;margin-bottom:4px}
    textarea, input[type="text"], input[type="password"], input[type="file"], select{width:100%;border-radius:12px;border:1px solid var(--outline);background:#0f1329;color:var(--ink);padding:10px;font-size:16px;line-height:1.4;font-family:inherit;outline:none;transition:border .15s ease,box-shadow .15s ease}
    textarea:focus, input[type="text"]:focus, input[type="password"]:focus, select:focus, input[type="file"]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(125,214,255,.14)}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;align-items:end}
    .subtle{color:var(--muted);font-size:13px}
    .moods{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
    .mood{border:1px solid var(--outline);border-radius:14px;padding:12px;cursor:pointer;display:flex;align-items:center;gap:10px;background:#0f1329;transition:border .15s ease,transform .1s ease}
    .mood input{display:none}
    .mood strong{font-size:16px}
    .mood small{color:var(--muted)}
    .mood[data-active="true"]{border-color:var(--accent);box-shadow:0 0 0 3px rgba(125,214,255,.12);transform:translateY(-1px);background:rgba(125,214,255,.05)}
    button{appearance:none;-webkit-appearance:none;background:linear-gradient(120deg,#7dd6ff,#b3ffdc);border:none;color:#0b1228;font-weight:800;border-radius:12px;padding:12px 14px;font-size:14px;cursor:pointer;box-shadow:0 10px 30px rgba(125,214,255,.26);transition:transform .1s ease,box-shadow .1s ease}
    button:active{transform:translateY(1px);box-shadow:0 6px 18px rgba(125,214,255,.26)}
    button[disabled]{opacity:.6;cursor:not-allowed;box-shadow:none}
    .ghost{background:rgba(255,255,255,.05);color:var(--ink);border:1px solid var(--outline);box-shadow:none}
    .switches{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px}
    .pill{padding:12px 14px;border-radius:14px;border:1px solid var(--outline);background:#0f1329;color:var(--ink);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .list{display:flex;flex-direction:column;gap:12px;max-height:520px;overflow:auto;padding-right:6px}
    .entry{border:1px solid var(--outline);border-radius:16px;padding:12px;background:#0f1329;display:grid;grid-template-columns:auto 1fr;gap:10px}
    .entry .tag{padding:6px 10px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-weight:700;display:inline-flex;align-items:center;gap:6px}
    .entry small{color:var(--muted)}
    .questions{display:grid;gap:8px}
    .question{padding:10px 12px;border-radius:10px;border:1px dashed var(--outline);background:rgba(255,255,255,.04)}
    .section-title{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .section-title h2{margin:0;font-size:18px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--outline);color:var(--ink);background:rgba(255,255,255,.05);cursor:pointer;transition:border .12s ease}
    .chip[data-active="true"]{border-color:var(--accent);background:rgba(125,214,255,.14);color:#0b1228}
    .summary-card{border:1px solid var(--outline);border-radius:14px;padding:12px;background:#0f1329;display:flex;flex-direction:column;gap:8px}
    .switch-btn{padding:10px 12px;border-radius:10px;border:1px solid var(--outline);background:rgba(255,255,255,.05);color:var(--ink);font-weight:800;cursor:pointer;box-shadow:none}
    .switch-btn[data-active="true"]{background:rgba(125,214,255,.16);border-color:var(--accent);color:#0b1228}
    .role-toggle{position:relative;display:grid;grid-template-columns:1fr 1fr;align-items:center;gap:8px;padding:8px;border-radius:999px;border:1px solid var(--outline);background:#0f1329;color:var(--muted);font-weight:800;min-width:190px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);cursor:pointer;user-select:none}
    .role-toggle .thumb{position:absolute;top:4px;left:4px;width:calc(50% - 6px);height:calc(100% - 8px);border-radius:999px;background:linear-gradient(120deg,#7dd6ff,#b3ffdc);transition:transform .18s ease}
    .role-toggle[data-role="prince"] .thumb{transform:translateX(100%)}
    .role-toggle .label{position:relative;text-align:center;z-index:1;color:var(--muted);transition:color .12s ease;font-weight:700}
    .role-toggle .label[data-active="true"]{color:#0b1228;font-weight:900}
    .attachment-preview{border:1px solid var(--outline);border-radius:10px;padding:10px;background:#0f1329;margin-top:6px}
    .attachment-preview img{max-width:100%;border-radius:8px}
    .entry .meta{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .badge-small{padding:4px 8px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:12px}
    .stack{display:flex;flex-direction:column;gap:6px}
    .forum-tools{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .attachment-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .read-toggle{margin-top:6px}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .section-bar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .tab-group{display:flex;gap:10px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:12px;border:1px solid var(--outline);background:rgba(255,255,255,.05);color:var(--ink);font-weight:800;cursor:pointer;box-shadow:none}
    .tab[data-active="true"]{border-color:var(--accent);background:rgba(125,214,255,.16);color:#0b1228}
    .topics-list{display:flex;flex-direction:column;gap:12px}
    .topic-card{border:1px solid var(--outline);border-radius:16px;padding:12px;display:grid;grid-template-columns:auto 1fr;gap:12px;background:#0f1329;box-shadow:var(--shadow)}
    .topic-card[data-read=\"true\"]{opacity:.82}
    .topic-icon{width:52px;height:52px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:24px}
    .topic-meta{display:flex;gap:6px;flex-wrap:wrap;align-items:center;font-weight:800}
    .topic-meta small{color:var(--muted);font-weight:500}
    .topic-sub{color:var(--muted);font-size:13px}
    .topic-text{margin-top:6px;font-size:15px}
    .topic-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .topic-actions button{padding:8px 10px;font-size:13px;box-shadow:none}
    button.danger{background:rgba(255,255,255,.05);color:#ffb3b3;border:1px solid rgba(255,255,255,.16)}
    button.danger:active{transform:translateY(1px);box-shadow:none}
    .summary-section{display:grid;gap:12px}
    .summary-row{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .pill-select{display:flex;gap:8px;flex-wrap:wrap}
    .pill-select button{padding:10px 12px;border-radius:12px;border:1px solid var(--outline);background:rgba(255,255,255,.05);color:var(--ink);box-shadow:none}
    .pill-select button[data-active="true"]{border-color:var(--accent);background:rgba(125,214,255,.12);color:#0b1228}
    @media (max-width:900px){body{padding:8px}.layout{flex-direction:column}.list{max-height:none}.forum-tools{grid-template-columns:1fr}.role-toggle{min-width:0}}
  </style>
</head>
<body>
  <div class="shell">
    <div class="hero">
      <header>
        <div>
          <div class="eyebrow">Zweisam, auch wenn wenig Zeit ist</div>
          <h1>Unser Check-in</h1>
          <p>Schreibt ein kurzes Update, haltet offene Themen fest und behaltet gemeinsam den √úberblick.</p>
        </div>
        <div class="badges">
          <div class="badge" id="lastUpdate">Keine Eintr√§ge</div>
        </div>
      </header>
    </div>

    <div class="layout" aria-live="polite">
      <div class="panel">
        <div class="section-bar">
          <div>
            <div class="eyebrow" style="margin:0">Check-in schreiben</div>
            <h2 style="margin:0">Wie geht es dir gerade?</h2>
          </div>
          <button id="saveBtn" type="button">Sichern & teilen</button>
        </div>
        
        <div>
          <label>Wer schreibt?</label>
          <div class="pill-select" id="authorToggle"></div>
        </div>

        <div>
          <label>Wie f√ºhlst du dich?</label>
          <div class="moods" id="moodList"></div>
        </div>
        <div class="row">
          <div class="pill">
            <div>
              <strong>Energie</strong>
              <div class="subtle">Wieviel Kapazit√§t hast du gerade?</div>
            </div>
            <input id="energy" type="range" min="1" max="10" value="5">
          </div>
          <div class="pill">
            <div>
              <strong>Gespr√§chswunsch</strong>
              <div class="subtle">Soll der andere reagieren?</div>
            </div>
            <select id="talkIntent" style="width:160px;border-radius:10px;border:1px solid var(--outline);background:#0f1329;color:var(--ink);padding:8px">
              <option value="wenn Zeit">Wenn Zeit ist</option>
              <option value="bitte melden">Bitte melden</option>
              <option value="nur Info">Nur Info</option>
            </select>
          </div>
        </div>
        <div>
          <label for="topic">Thema festhalten</label>
          <textarea id="topic" placeholder="Was m√∂chtest du sp√§ter teilen oder besprechen?"></textarea>
          <div class="subtle">Kurz & einfach reicht. Der Eintrag bleibt, bis ihr ihn abhakt oder 14 Tage vorbei sind.</div>
        </div>

      <div class="panel">
        <div class="section-bar">
          <div>
            <div class="eyebrow" style="margin:0">Offene Themen</div>
            <h2 style="margin:0">Was steht an?</h2>
          </div>
          <div class="tab-group" id="filterTabs"></div>
        </div>

        <div class="topics-list" id="openList"></div>

        <div class="summary-section">
          <div class="summary-row">
            <h3 style="margin:0;font-size:18px">Zusammenfassung f√ºr E</h3>
            <button id="copySummary" type="button" class="ghost">In Zwischenablage kopieren</button>
          </div>
          <div class="summary-card" id="summaryText"></div>
          <div class="summary-card" id="quickInfo"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const STORAGE_KEY = 'tandem-checkins-v3';
  const TTL_MS = 14 * 24 * 60 * 60 * 1000;
  const moods = [
    { id:'ruhig', label:'Ruhig', emoji:'üåø', tone:'ausgeglichen' },
    { id:'gestresst', label:'Gestresst', emoji:'‚ö°Ô∏è', tone:'unter Strom' },
    { id:'muede', label:'M√ºde', emoji:'ü•±', tone:'ersch√∂pft' },
    { id:'freudig', label:'Freudig', emoji:'‚ú®', tone:'positiv' },
    { id:'genervt', label:'Genervt', emoji:'üôÑ', tone:'gereizt' },
    { id:'dankbar', label:'Dankbar', emoji:'ü§ç', tone:'zugewandt' }
  ];


  const moodList = document.getElementById('moodList');
  const lastUpdate = document.getElementById('lastUpdate');
  const questionBox = document.getElementById('questionBox');
  const refreshQuestionsBtn = document.getElementById('refreshQuestions');
  const filterTabs = document.getElementById('filterTabs');
  const openList = document.getElementById('openList');
  const summaryText = document.getElementById('summaryText');
  const quickInfo = document.getElementById('quickInfo');
  const authorToggle = document.getElementById('authorToggle');
  const selfNameInput = document.getElementById('selfName');
  const partnerNameInput = document.getElementById('partnerName');

  const defaultState = {
    entries: [],
    archived: [],
    lastMood: 'ruhig',
    currentAuthor: 'self',
    selfName: 'N',
    partnerName: 'E',
    filter: 'all',
    questions: []
  };

  let state = load();
  normalizeState();
  hydrateForm();
  renderAuthorToggle();
  renderMoods();
  renderFilters();
  renderOpenTopics();
  const hasQuestionsUI = questionBox && refreshQuestionsBtn;
  if(hasQuestionsUI){
    renderQuestions();
    if(!state.questions.length) refreshQuestions();
  }

  document.getElementById('saveBtn').addEventListener('click', saveEntry);
  if(refreshQuestionsBtn) refreshQuestionsBtn.addEventListener('click', refreshQuestions);
  document.getElementById('copySummary').addEventListener('click', copySummary);
  if(selfNameInput) selfNameInput.addEventListener('input', () => updateNames('self', selfNameInput.value));
  if(partnerNameInput) partnerNameInput.addEventListener('input', () => updateNames('partner', partnerNameInput.value));

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return {...defaultState};
      return { ...defaultState, ...JSON.parse(raw) };
    }catch(e){
      return {...defaultState};
    }
  }

  function persist(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function normalizeState(){
    if(!Array.isArray(state.entries)) state.entries = [];
    if(!Array.isArray(state.archived)) state.archived = [];
    if(!Array.isArray(state.questions)) state.questions = [];
    if(!state.selfName) state.selfName = 'N';
    if(!state.partnerName) state.partnerName = 'E';
    if(!state.currentAuthor) state.currentAuthor = 'self';
    if(!state.filter) state.filter = 'all';

    const cutoff = Date.now() - TTL_MS;
    const fresh = [];
    const archivedMap = new Map(state.archived.map(a => [a.id, a]));

    state.entries.forEach(entry => {
      const migrated = { ...entry };
      if(!migrated.authorType){
        if(entry.authorRole === 'prince') migrated.authorType = 'partner';
        else migrated.authorType = 'self';
      }
      migrated.authorName = migrated.authorName || (migrated.authorType === 'partner' ? state.partnerName : state.selfName);
      migrated.talkIntent = migrated.talkIntent || 'wenn Zeit';
      migrated.readBy = migrated.readBy || {};
      if(typeof migrated.isRead === 'undefined') migrated.isRead = false;
      if(!migrated.moodLabel || !migrated.emoji){
        const meta = moods.find(m => m.id === migrated.mood) || moods[0];
        migrated.moodLabel = migrated.moodLabel || meta.label;
        migrated.emoji = migrated.emoji || meta.emoji;
      }

      if(migrated.createdAt < cutoff){
        migrated.archivedAt = migrated.archivedAt || Date.now();
        if(!archivedMap.has(migrated.id)){
          archivedMap.set(migrated.id, migrated);
        }
      } else {
        fresh.push(migrated);
      }
    });

    state.entries = fresh;
    state.archived = Array.from(archivedMap.values());
    persist();
  }

  function hydrateForm(){
    document.getElementById('energy').value = 5;
    document.getElementById('topic').value = '';
    document.getElementById('talkIntent').value = 'wenn Zeit';
    if(selfNameInput) selfNameInput.value = state.selfName;
    if(partnerNameInput) partnerNameInput.value = state.partnerName;
  }

  function renderAuthorToggle(){
    authorToggle.innerHTML = '';
    const items = [
      { id:'self', label: state.selfName || 'N' },
      { id:'partner', label: state.partnerName || 'E' }
    ];
    items.forEach(item => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = item.label || item.id;
      btn.dataset.active = state.currentAuthor === item.id;
      btn.addEventListener('click', () => {
        state.currentAuthor = item.id;
        persist();
        renderAuthorToggle();
      });
      authorToggle.appendChild(btn);
    });
  }

  function renderMoods(){
    moodList.innerHTML = '';
    moods.forEach(m => {
      const label = document.createElement('label');
      label.className = 'mood';
      label.dataset.active = m.id === state.lastMood;

      const input = document.createElement('input');
      input.type = 'radio';
      input.name = 'mood';
      input.value = m.id;
      input.checked = m.id === state.lastMood;
      input.addEventListener('change', () => {
        state.lastMood = m.id;
        persist();
        renderMoods();
        if(hasQuestionsUI) refreshQuestions();
      });

      const icon = document.createElement('div');
      icon.style.fontSize = '22px';
      icon.textContent = m.emoji;

      const text = document.createElement('div');
      const strong = document.createElement('strong');
      strong.textContent = m.label;
      const small = document.createElement('small');
      small.textContent = `Gef√ºhl: ${m.tone}`;
      text.append(strong, document.createElement('br'), small);

      label.append(input, icon, text);
      moodList.appendChild(label);
    });
  }

  function renderFilters(){
    filterTabs.innerHTML = '';
    const tabs = [
      { value:'all', label:'Alle Eintr√§ge' },
      { value:'self', label: state.selfName || 'N' },
      { value:'partner', label: state.partnerName || 'E' }
    ];
    tabs.forEach(tab => {
      const node = document.createElement('button');
      node.type = 'button';
      node.className = 'tab';
      node.textContent = tab.label;
      node.dataset.active = state.filter === tab.value;
      node.addEventListener('click', () => {
        state.filter = tab.value;
        persist();
        renderFilters();
        renderOpenTopics();
      });
      filterTabs.appendChild(node);
    });
  }

  function renderOpenTopics(){
    normalizeState();
    openList.innerHTML = '';
    const entries = state.entries
      .map(enrichEntry)
      .filter(e => {
        if(state.filter === 'all') return true;
        return e.authorType === state.filter;
      })
      .sort((a,b)=>b.createdAt-a.createdAt);

    if(entries.length === 0){
      const empty = document.createElement('div');
      empty.className = 'subtle';
      empty.textContent = 'Noch keine Eintr√§ge. Schreib den ersten Check-in!';
      openList.appendChild(empty);
      lastUpdate.textContent = 'Keine Eintr√§ge';
      summaryText.textContent = 'Noch keine Daten f√ºr die Zusammenfassung.';
      quickInfo.textContent = 'Hier landet dein Kurzupdate f√ºr E.';
      return;
    }

    const formatter = new Intl.DateTimeFormat('de-DE',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'short'});

    entries.forEach(entry => {
      const card = document.createElement('div');
      card.className = 'topic-card';
      card.dataset.read = entry.isRead ? 'true' : 'false';

      const icon = document.createElement('div');
      icon.className = 'topic-icon';
      icon.textContent = entry.emoji;

      const body = document.createElement('div');
      const meta = document.createElement('div');
      meta.className = 'topic-meta';
      const author = document.createElement('strong');
      author.textContent = entry.authorName || 'Unbekannt';
      const dot = document.createElement('small');
      dot.textContent = formatter.format(entry.createdAt);
      meta.append(author, document.createTextNode(' ¬∑ '), dot);

      const sub = document.createElement('div');
      sub.className = 'topic-sub';
      sub.textContent = `Energie: ${entry.energy}/10 ¬∑ Wunsch: ${entry.talkIntent}`;

      const text = document.createElement('div');
      text.className = 'topic-text';
      text.textContent = entry.topic || 'Kein Text';
      if(!entry.topic) text.classList.add('subtle');

      const actions = document.createElement('div');
      actions.className = 'topic-actions';
      const readBtn = document.createElement('button');
      readBtn.type = 'button';
      readBtn.className = 'ghost';
      readBtn.textContent = entry.isRead ? 'Als ungelesen markieren' : 'Gelesen';
      readBtn.addEventListener('click', () => toggleRead(entry.id));

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'danger';
      deleteBtn.textContent = 'L√∂schen';
      deleteBtn.addEventListener('click', () => deleteEntry(entry.id));

      actions.append(readBtn, deleteBtn);

      body.append(meta, sub, text, actions);
      card.append(icon, body);
      openList.appendChild(card);
    });

    const latest = entries[0];
    lastUpdate.textContent = 'Letzter Eintrag: ' + formatter.format(latest.createdAt);
    summaryText.textContent = buildSummary(latest);
    quickInfo.textContent = buildQuickInfo(latest);
  }

  function renderQuestions(){
    questionBox.innerHTML = '';
    if(!state.questions || state.questions.length === 0){
      const placeholder = document.createElement('div');
      placeholder.className = 'subtle';
      placeholder.textContent = 'Noch keine Fragen geladen.';
      questionBox.appendChild(placeholder);
      return;
    }
    state.questions.forEach(q => {
      const node = document.createElement('div');
      node.className = 'question';
      node.textContent = q;
      questionBox.appendChild(node);
    });
  }

  function refreshQuestions(){
    if(!hasQuestionsUI || typeof questionPool === 'undefined') return;
    const mood = state.lastMood;
    const pool = questionPool[mood] || questionPool.fallback;
    const shuffled = [...pool].sort(()=>Math.random()-0.5);
    state.questions = shuffled.slice(0,3);
    persist();
    renderQuestions();
  }

  function enrichEntry(entry){
    const meta = moods.find(m => m.id === entry.mood) || moods[0];
    return {
      ...entry,
      authorType: entry.authorType || 'self',
      authorName: entry.authorName || (entry.authorType === 'partner' ? state.partnerName : state.selfName),
      moodLabel: entry.moodLabel || meta.label,
      emoji: entry.emoji || meta.emoji
    };
  }

  function saveEntry(){
    const mood = state.lastMood || 'ruhig';
    const moodMeta = moods.find(m => m.id === mood) || moods[0];
    const energy = Number(document.getElementById('energy').value) || 5;
    const topic = document.getElementById('topic').value.trim();
    const talkIntent = document.getElementById('talkIntent').value;
    const createdAt = Date.now();
    const authorType = state.currentAuthor || 'self';

    const entry = {
      id: crypto.randomUUID ? crypto.randomUUID() : `${createdAt}-${Math.random()}`,
      authorType,
      authorName: authorType === 'partner' ? (state.partnerName || 'E') : (state.selfName || 'N'),
      mood,
      moodLabel: moodMeta.label,
      emoji: moodMeta.emoji,
      energy,
      talkIntent,
      topic,
      isRead: false,
      createdAt
    };

    state.entries.push(entry);
    persist();
    hydrateForm();
    renderOpenTopics();
    openList.scrollIntoView({ behavior:'smooth', block:'start' });
  }

  function buildSummary(entry){
    if(!entry) return 'Noch keine Daten f√ºr die Zusammenfassung.';
    const note = entry.topic ? entry.topic : 'Keine extra Notiz.';
    return `${entry.authorName} f√ºhlt sich ${entry.moodLabel.toLowerCase()} (${entry.energy}/10 Energie). ${note} Wunsch: ${entry.talkIntent}.`;
  }

  function buildQuickInfo(entry){
    if(!entry) return 'Hier landet dein Kurzupdate f√ºr E.';
    const note = entry.topic ? entry.topic : 'Keine extra Notiz.';
    return `${entry.authorName} f√ºhlt sich ${entry.moodLabel.toLowerCase()} (${entry.energy}/10 Energie). ${note} Wunsch: ${entry.talkIntent}.`;
  }

  async function copySummary(){
    const text = summaryText.textContent || '';
    try{
      await navigator.clipboard.writeText(text);
      summaryText.textContent = text + ' (kopiert)';
      setTimeout(()=>{ summaryText.textContent = text; }, 1500);
    }catch(e){
      summaryText.textContent = 'Konnte nicht kopieren.';
    }
  }

  function updateNames(type, value){
    const cleaned = value.trim() || (type === 'partner' ? 'E' : 'N');
    if(type === 'self') state.selfName = cleaned;
    if(type === 'partner') state.partnerName = cleaned;
    persist();
    renderAuthorToggle();
    renderFilters();
    renderOpenTopics();
  }

  function toggleRead(id){
    const entry = state.entries.find(e => e.id === id);
    if(!entry) return;
    entry.isRead = !entry.isRead;
    persist();
    renderOpenTopics();
  }

  function deleteEntry(id){
    state.entries = state.entries.filter(e => e.id !== id);
    persist();
    renderOpenTopics();
  }
})();
</script>

<!-- Service Worker Registrierung -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(reg => {
      function readyToActivate(sw) {
        if (sw && sw.state === 'installed') {
          if (navigator.serviceWorker.controller) {
            sw.postMessage({ type: 'SKIP_WAITING' });
          }
        }
      }
      if (reg.waiting) readyToActivate(reg.waiting);
      reg.addEventListener('updatefound', () => {
        const sw = reg.installing;
        sw && sw.addEventListener('statechange', () => readyToActivate(sw));
      });
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        window.location.reload();
      });
    }).catch(console.error);
  });
}
</script>
</body>
</html>
