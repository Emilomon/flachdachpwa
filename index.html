<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Wir zwei ‚Äì Check-in App</title>
  <meta name="format-detection" content="telephone=no" />

  <!-- PWA (Android/General) -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0d1025" />

  <!-- PWA (Apple/iOS) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png" />

  <style>
    :root{
      --bg:#0d1025;--panel:#151a32;--ink:#e9edff;--muted:#a8b2d6;--accent:#7dd6ff;--accent-2:#b3ffdc;--card:#1b2040;--outline:#2c3358;--shadow:0 18px 56px rgba(8,12,32,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{background:radial-gradient(circle at 20% 20%,rgba(125,214,255,.15),transparent 28%),radial-gradient(circle at 80% 0%,rgba(179,255,220,.16),transparent 30%),var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;padding:12px;display:flex;flex-direction:column;align-items:center;min-height:100vh;gap:14px;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:rgba(255,255,255,0)}
    @supports(padding:max(0px)){
      body{padding-top:max(12px,env(safe-area-inset-top));padding-right:max(12px,env(safe-area-inset-right));padding-bottom:max(12px,env(safe-area-inset-bottom));padding-left:max(12px,env(safe-area-inset-left))}
    }
    .shell{width:min(1200px,98vw);margin:auto;display:flex;flex-direction:column;gap:14px}
    .hero{background:linear-gradient(135deg,rgba(125,214,255,.24),rgba(179,255,220,.14));border:1px solid rgba(255,255,255,.1);border-radius:22px;padding:18px 18px 16px;box-shadow:var(--shadow)}
    header{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;align-items:flex-start}
    h1{margin:0;font-size:clamp(22px,4vw,30px);letter-spacing:-0.3px}
    p{margin:0;color:var(--muted);line-height:1.5}
    .eyebrow{font-size:12px;letter-spacing:1px;text-transform:uppercase;color:#9fd9ff;margin-bottom:4px;font-weight:700}
    .badges{display:flex;flex-wrap:wrap;gap:8px}
    .badge{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:8px 10px;font-variant-numeric:tabular-nums;color:var(--ink);display:flex;align-items:center;gap:6px}
    .layout{margin-top:14px;display:flex;flex-direction:column;gap:14px}
    .panel{background:var(--card);border:1px solid var(--outline);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:12px;box-shadow:var(--shadow)}
    label{font-weight:700;color:var(--ink);display:block;margin-bottom:4px}
    textarea, input[type="text"], input[type="password"], input[type="file"], select{width:100%;border-radius:12px;border:1px solid var(--outline);background:#0f1329;color:var(--ink);padding:10px;font-size:16px;line-height:1.4;font-family:inherit;outline:none;transition:border .15s ease,box-shadow .15s ease}
    textarea:focus, input[type="text"]:focus, input[type="password"]:focus, select:focus, input[type="file"]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(125,214,255,.14)}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;align-items:end}
    .subtle{color:var(--muted);font-size:13px}
    .moods{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px}
    .mood{border:1px solid var(--outline);border-radius:12px;padding:10px;cursor:pointer;display:flex;align-items:center;gap:10px;background:#0f1329;transition:border .15s ease,transform .1s ease}
    .mood input{display:none}
    .mood strong{font-size:16px}
    .mood small{color:var(--muted)}
    .mood[data-active="true"]{border-color:var(--accent);box-shadow:0 0 0 3px rgba(125,214,255,.12);transform:translateY(-1px)}
    button{appearance:none;-webkit-appearance:none;background:linear-gradient(120deg,#7dd6ff,#b3ffdc);border:none;color:#0b1228;font-weight:800;border-radius:12px;padding:12px 14px;font-size:14px;cursor:pointer;box-shadow:0 10px 30px rgba(125,214,255,.26);transition:transform .1s ease,box-shadow .1s ease}
    button:active{transform:translateY(1px);box-shadow:0 6px 18px rgba(125,214,255,.26)}
    button[disabled]{opacity:.6;cursor:not-allowed;box-shadow:none}
    .ghost{background:rgba(255,255,255,.05);color:var(--ink);border:1px solid var(--outline);box-shadow:none}
    .switches{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px}
    .pill{padding:10px 12px;border-radius:12px;border:1px solid var(--outline);background:#0f1329;color:var(--ink);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .list{display:flex;flex-direction:column;gap:10px;max-height:520px;overflow:auto;padding-right:6px}
    .entry{border:1px solid var(--outline);border-radius:14px;padding:12px;background:#0f1329;display:grid;grid-template-columns:auto 1fr;gap:10px}
    .entry .tag{padding:6px 10px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-weight:700;display:inline-flex;align-items:center;gap:6px}
    .entry small{color:var(--muted)}
    .questions{display:grid;gap:8px}
    .question{padding:10px 12px;border-radius:10px;border:1px dashed var(--outline);background:rgba(255,255,255,.04)}
    .section-title{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .section-title h2{margin:0;font-size:18px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--outline);color:var(--ink);background:rgba(255,255,255,.05);cursor:pointer;transition:border .12s ease}
    .chip[data-active="true"]{border-color:var(--accent);background:rgba(125,214,255,.14);color:#0b1228}
    .summary-card{border:1px solid var(--outline);border-radius:14px;padding:12px;background:#0f1329;display:flex;flex-direction:column;gap:8px}
    .switch-btn{padding:10px 12px;border-radius:10px;border:1px solid var(--outline);background:rgba(255,255,255,.05);color:var(--ink);font-weight:800;cursor:pointer;box-shadow:none}
    .switch-btn[data-active="true"]{background:rgba(125,214,255,.16);border-color:var(--accent);color:#0b1228}
    .role-toggle{position:relative;display:grid;grid-template-columns:1fr 1fr;align-items:center;gap:8px;padding:8px;border-radius:999px;border:1px solid var(--outline);background:#0f1329;color:var(--muted);font-weight:800;min-width:190px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);cursor:pointer;user-select:none}
    .role-toggle .thumb{position:absolute;top:4px;left:4px;width:calc(50% - 6px);height:calc(100% - 8px);border-radius:999px;background:linear-gradient(120deg,#7dd6ff,#b3ffdc);transition:transform .18s ease}
    .role-toggle[data-role="prince"] .thumb{transform:translateX(100%)}
    .role-toggle .label{position:relative;text-align:center;z-index:1;color:var(--muted);transition:color .12s ease;font-weight:700}
    .role-toggle .label[data-active="true"]{color:#0b1228;font-weight:900}
    .attachment-preview{border:1px solid var(--outline);border-radius:10px;padding:10px;background:#0f1329;margin-top:6px}
    .attachment-preview img{max-width:100%;border-radius:8px}
    .entry .meta{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .badge-small{padding:4px 8px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:12px}
    .stack{display:flex;flex-direction:column;gap:6px}
    .forum-tools{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .attachment-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .read-toggle{margin-top:6px}
    @media (max-width:900px){body{padding:8px}.layout{flex-direction:column}.list{max-height:none}.forum-tools{grid-template-columns:1fr}.role-toggle{min-width:0}}
  </style>
</head>
<body>
  <div class="shell">
    <div class="hero">
      <header>
        <div>
          <div class="eyebrow">Zweisam, auch wenn wenig Zeit ist</div>
          <h1>Unser Check-in</h1>
          <p>Teilt eure Stimmung, sprecht per Text oder Sprachnachricht, h√§ngt Fotos an und haltet den √úberblick wie in einem kleinen Forum.</p>
        </div>
        <div class="badges">
          <div class="badge">PWA ¬∑ offlinef√§hig</div>
          <div class="badge" id="lastUpdate">Keine Eintr√§ge</div>
        </div>
      </header>
    </div>

    <div class="layout" aria-live="polite">
      <div class="panel">
        <div class="section-title">
          <h2>Check-in schreiben</h2>
        </div>

        <div class="pill">
          <div>
            <strong>Wer bist du?</strong>
            <div class="subtle">Schalte zwischen euch hin und her.</div>
          </div>
          <div class="role-toggle" id="roleSwitch" role="switch" aria-checked="false" tabindex="0">
            <div class="thumb" aria-hidden="true"></div>
            <div class="label left" data-role-label="princess">üë∏ N</div>
            <div class="label right" data-role-label="prince">ü§¥ E</div>
          </div>
        </div>
        <div class="subtle" id="roleIndicator" aria-live="polite"></div>

        <div>
          <label>Wie f√ºhlst du dich?</label>
          <div class="moods" id="moodList"></div>
        </div>
        <div class="row">
          <div class="pill">
            <div>
              <strong>Energie</strong>
              <div class="subtle">Wieviel Kapazit√§t hast du gerade?</div>
            </div>
            <input id="energy" type="range" min="1" max="10" value="5">
          </div>
          <div class="pill">
            <div>
              <strong>Gespr√§chswunsch</strong>
              <div class="subtle">Soll der andere reagieren?</div>
            </div>
            <select id="talkIntent" style="width:140px;border-radius:10px;border:1px solid var(--outline);background:#0f1329;color:var(--ink);padding:8px">
              <option value="wenn Zeit">Wenn Zeit ist</option>
              <option value="bitte melden">Bitte bald melden</option>
              <option value="nur Info">Nur Info</option>
            </select>
          </div>
        </div>
        <div>
          <label for="topic">Thema festhalten</label>
          <textarea id="topic" placeholder="Was m√∂chtest du teilen oder besprechen?"></textarea>
          <div class="subtle">Kurz & einfach reicht. Der Eintrag bleibt als Forumspost, bis ihr ihn abhakt oder die 14 Tage vorbei sind.</div>
        </div>
        <div class="section-title">
          <h2>Mood Check-up</h2>
          <button id="refreshQuestions" type="button" class="ghost">Fragen aktualisieren</button>
        </div>
        <div class="subtle">Drei kurze Impulse passend zu deiner aktuellen Stimmung.</div>
        <div class="questions" id="questionBox"></div>

        <div class="row">
          <div class="pill" style="flex-direction:column;align-items:flex-start">
            <div class="section-title" style="width:100%">
              <h3 style="margin:0;font-size:16px">Sprachnachricht</h3>
              <button id="voiceBtn" type="button" class="ghost">Aufnahme starten</button>
            </div>
            <div class="subtle" id="voiceStatus">Bereit zum Aufnehmen.</div>
            <div class="attachment-preview" id="voicePreview" hidden>
              <audio controls style="width:100%"></audio>
              <button id="clearVoice" type="button" class="ghost" style="margin-top:6px">Sprachnachricht entfernen</button>
            </div>
          </div>
          <div class="pill" style="flex-direction:column;align-items:flex-start">
            <h3 style="margin:0;font-size:16px">Foto anh√§ngen</h3>
            <input id="photoInput" type="file" accept="image/*" />
            <div class="attachment-preview" id="photoPreview" hidden>
              <img alt="Angeh√§ngtes Foto" />
              <button id="clearPhoto" type="button" class="ghost" style="margin-top:6px">Foto entfernen</button>
            </div>
            <div class="subtle">Optionales Foto zu deinem Eintrag.</div>
          </div>
        </div>
        <div class="section-title" style="justify-content:flex-end">
          <button id="saveBtn" type="button">Posten</button>
        </div>

        <div class="section-title">
          <h2>Deine Check-ins</h2>
          <div class="chips" id="filters"></div>
        </div>
        <div class="subtle">Nach dem Posten erscheint dein Beitrag direkt hier.</div>
        <div class="list" id="entryList"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const STORAGE_KEY = 'tandem-checkins-v2';
  const TTL_MS = 14 * 24 * 60 * 60 * 1000;
  const moods = [
    { id:'ruhig', label:'Ruhig', emoji:'üåø', tone:'ausgeglichen' },
    { id:'gestresst', label:'Gestresst', emoji:'‚ö°Ô∏è', tone:'unter Strom' },
    { id:'m√ºde', label:'M√ºde', emoji:'üò¥', tone:'ersch√∂pft' },
    { id:'freudig', label:'Freudig', emoji:'‚ú®', tone:'positiv' },
    { id:'genervt', label:'Genervt', emoji:'üôÑ', tone:'gereizt' },
    { id:'dankbar', label:'Dankbar', emoji:'ü§ç', tone:'zugewandt' },
  ];
  const questionPool = {
    ruhig: [
      'Was hat dir heute Ruhe gegeben?',
      'Gibt es etwas, das du gern so beibehalten m√∂chtest?',
      'Welche Kleinigkeit k√∂nnen wir heute teilen?'
    ],
    gestresst: [
      'Was frisst gerade die meiste Energie?',
      'Wobei w√ºrdest du dir kurze Unterst√ºtzung w√ºnschen?',
      'Was k√∂nnte dir helfen, einmal durchzuatmen?'
    ],
    m√ºde: [
      'Was hat dich heute ersch√∂pft?',
      'Was braucht heute keinen Perfektionismus?',
      'Gibt es etwas, das du verschieben kannst?'
    ],
    freudig: [
      'Was hat dich heute gefreut?',
      'Wen m√∂chtest du an deiner Freude teilhaben lassen?',
      'Was k√∂nnen wir davon festhalten?'
    ],
    genervt: [
      'Was nervt dich konkret?',
      'Braucht es nur Geh√∂r oder eine L√∂sung?',
      'Was w√§re ein kleiner Schritt, der Druck rausnimmt?'
    ],
    dankbar: [
      'Wof√ºr bist du heute dankbar?',
      'M√∂chtest du jemandem Danke sagen?',
      'Welche Geste hat dich ber√ºhrt?'
    ],
    fallback: [
      'Welche √úberschrift h√§tte dein Tag?',
      'Was darf dein Partner jetzt √ºber dich wissen?',
      'Wie kann man dir heute etwas Gutes tun?'
    ]
  };
  const roles = {
    princess: { label:'üë∏ N', color:'accent' },
    prince: { label:'ü§¥ E', color:'accent2' }
  };

  const moodList = document.getElementById('moodList');
  const entryList = document.getElementById('entryList');
  const filters = document.getElementById('filters');
  const lastUpdate = document.getElementById('lastUpdate');
  const roleSwitch = document.getElementById('roleSwitch');
  const roleIndicator = document.getElementById('roleIndicator');
  const roleLabels = {
    princess: roleSwitch.querySelector('[data-role-label="princess"]'),
    prince: roleSwitch.querySelector('[data-role-label="prince"]')
  };
  const voiceBtn = document.getElementById('voiceBtn');
  const voiceStatus = document.getElementById('voiceStatus');
  const voicePreview = document.getElementById('voicePreview');
  const voiceAudio = voicePreview.querySelector('audio');
  voiceAudio.setAttribute('playsinline','');
  const clearVoiceBtn = document.getElementById('clearVoice');
  const photoInput = document.getElementById('photoInput');
  const photoPreview = document.getElementById('photoPreview');
  const clearPhotoBtn = document.getElementById('clearPhoto');
  const supportsMediaRecorder = typeof MediaRecorder !== 'undefined' && typeof navigator.mediaDevices?.getUserMedia === 'function';

  const defaultState = { entries: [], archived: [], lastMood: 'ruhig', currentRole: 'princess', filter: null, questions: [] };
  let state = load();
  normalizeState();
  hydrateForm();
  initRoleToggle();
  renderMoods();
  renderFilters();
  renderEntries();
  renderQuestions();
  if(!state.questions.length) refreshQuestions();

  document.getElementById('saveBtn').addEventListener('click', saveEntry);
  if(!supportsMediaRecorder){
    voiceBtn.disabled = true;
    voiceBtn.textContent = 'Aufnahme nicht unterst√ºtzt';
    voiceStatus.textContent = 'Auf diesem Ger√§t sind Sprachnachrichten nicht m√∂glich.';
  } else {
    voiceBtn.addEventListener('click', toggleRecording);
  }
  clearVoiceBtn.addEventListener('click', ()=>{ currentVoice = null; renderVoicePreview(); });
  photoInput.addEventListener('change', handlePhotoSelect);
  clearPhotoBtn.addEventListener('click', ()=>{ currentPhoto = null; renderPhotoPreview(); });

  let mediaRecorder = null;
  let chunks = [];
  let currentVoice = null;
  let currentPhoto = null;
  let activeStream = null;
  const preferredMimeType = getPreferredMimeType();

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return {...defaultState};
      return { ...defaultState, ...JSON.parse(raw) };
    }catch(e){
      return {...defaultState};
    }
  }

  function persist(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function normalizeState(){
    if(!Array.isArray(state.entries)) state.entries = [];
    if(!Array.isArray(state.archived)) state.archived = [];
    if(!Array.isArray(state.questions)) state.questions = [];
    if(!state.currentRole) state.currentRole = 'princess';
    const cutoff = Date.now() - TTL_MS;
    const archivedMap = new Map(state.archived.map(a => [a.id, a]));
    const fresh = [];
    state.entries.forEach(entry => {
      if(!entry.readBy) entry.readBy = { princess: false, prince: false };
      if(entry.createdAt < cutoff){
        entry.archivedAt = entry.archivedAt || Date.now();
        if(!archivedMap.has(entry.id)){
          archivedMap.set(entry.id, entry);
        }
      } else {
        fresh.push(entry);
      }
    });
    state.entries = fresh;
    state.archived = Array.from(archivedMap.values());
    persist();
  }

  function hydrateForm(){
    document.getElementById('energy').value = 5;
    document.getElementById('topic').value = '';
    document.getElementById('talkIntent').value = 'wenn Zeit';
    currentVoice = null;
    currentPhoto = null;
    renderVoicePreview();
    renderPhotoPreview();
  }

  function initRoleToggle(){
    const setRole = (role) => {
      if(role !== 'princess' && role !== 'prince') return;
      if(state.currentRole === role){
        updateRoleToggle();
        return;
      }
      state.currentRole = role;
      persist();
      updateRoleToggle();
      renderEntries();
      renderFilters();
    };
    const toggleRole = () => setRole(state.currentRole === 'princess' ? 'prince' : 'princess');
    roleSwitch.addEventListener('click', (evt) => {
      const requested = evt.target.closest('[data-role-label]')?.dataset.roleLabel;
      if(requested){
        setRole(requested);
        return;
      }
      toggleRole();
    });
    roleSwitch.addEventListener('keydown', (evt) => {
      if(evt.key === ' ' || evt.key === 'Enter'){
        evt.preventDefault();
        toggleRole();
      }
    });
    updateRoleToggle();
  }

  function updateRoleToggle(){
    roleSwitch.dataset.role = state.currentRole;
    roleSwitch.setAttribute('aria-checked', state.currentRole === 'prince');
    roleSwitch.setAttribute('aria-label', `Aktive Rolle: ${roles[state.currentRole].label}`);
    Object.entries(roleLabels).forEach(([key, node]) => {
      if(!node) return;
      node.dataset.active = key === state.currentRole;
    });
    if(roleIndicator){
      roleIndicator.textContent = `${roles[state.currentRole].label} ist aktiv`;
    }
  }

  function renderMoods(){
    moodList.innerHTML = '';
    moods.forEach(m => {
      const label = document.createElement('label');
      label.className = 'mood';
      label.dataset.active = m.id === state.lastMood;

      const input = document.createElement('input');
      input.type = 'radio';
      input.name = 'mood';
      input.value = m.id;
      input.checked = m.id === state.lastMood;
      input.addEventListener('change', () => {
        state.lastMood = m.id;
        persist();
        renderMoods();
        refreshQuestions();
      });

      const icon = document.createElement('div');
      icon.style.fontSize = '22px';
      icon.textContent = m.emoji;

      const text = document.createElement('div');
      const strong = document.createElement('strong');
      strong.textContent = m.label;
      const small = document.createElement('small');
      small.textContent = `Gef√ºhl: ${m.tone}`;
      text.append(strong, document.createElement('br'), small);

      label.append(input, icon, text);
      moodList.appendChild(label);
    });
  }

  function renderFilters(){
    filters.innerHTML = '';
    const chipData = [
      { value: 'all', label: 'Alle Posts' },
      { value: 'princess', label: roles.princess.label },
      { value: 'prince', label: roles.prince.label },
      { value: 'unread', label: 'Ungelesen' }
    ];
    chipData.forEach(ch => {
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'chip';
      chip.textContent = ch.label;
      chip.dataset.value = ch.value;
      chip.dataset.active = state.filter ? state.filter === ch.value : ch.value === 'all';
      chip.addEventListener('click', () => {
        state.filter = ch.value === 'all' ? null : ch.value;
        persist();
        renderFilters();
        renderEntries();
      });
      filters.appendChild(chip);
    });
  }

  function renderEntries(){
    normalizeState();
    entryList.innerHTML = '';
    const list = state.entries
      .map(enrichEntry)
      .filter(e => {
        if(!state.filter || state.filter === 'all') return true;
        if(state.filter === 'unread') return !e.readBy[state.currentRole];
        return e.authorRole === state.filter;
      })
      .sort((a,b)=>b.createdAt-a.createdAt);

    if(list.length === 0){
      const empty = document.createElement('div');
      empty.className = 'subtle';
      empty.textContent = 'Noch keine Eintr√§ge. Schreib den ersten Check-in!';
      entryList.appendChild(empty);
      lastUpdate.textContent = 'Keine Eintr√§ge';
      return;
    }

    const formatter = new Intl.DateTimeFormat('de-DE',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'short'});

    list.forEach(entry => {
      const node = document.createElement('div');
      node.className = 'entry';

      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.textContent = `${entry.emoji} ${entry.moodLabel}`;

      const body = document.createElement('div');
      const headerLine = document.createElement('div');
      headerLine.className = 'meta';
      const author = document.createElement('strong');
      author.textContent = entry.authorLabel;
      const time = document.createElement('small');
      time.textContent = formatter.format(entry.createdAt);
      const energy = document.createElement('small');
      energy.textContent = `Energie: ${entry.energy}/10`;
      const intent = document.createElement('small');
      intent.textContent = `Wunsch: ${entry.talkIntent}`;
      const readBadge = document.createElement('span');
      readBadge.className = 'badge-small';
      readBadge.textContent = entry.readBy[state.currentRole] ? 'F√ºr dich gelesen' : 'F√ºr dich ungelesen';
      headerLine.append(author, document.createTextNode(' ¬∑ '), time, energy, intent, readBadge);

      const topicLine = document.createElement('div');
      topicLine.style.marginTop = '6px';
      if(entry.topic){
        topicLine.textContent = entry.topic;
      } else {
        const empty = document.createElement('span');
        empty.className = 'subtle';
        empty.textContent = 'Kein Text';
        topicLine.append(empty);
      }

      if(entry.voiceNote){
        const voiceWrap = document.createElement('div');
        voiceWrap.className = 'attachment-preview';
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = entry.voiceNote.data;
        voiceWrap.append(document.createTextNode('Sprachnachricht'), audio);
        body.appendChild(voiceWrap);
      }

      if(entry.photo){
        const photoWrap = document.createElement('div');
        photoWrap.className = 'attachment-preview';
        const img = document.createElement('img');
        img.src = entry.photo.data;
        img.alt = 'Angeh√§ngtes Foto';
        photoWrap.append(document.createTextNode('Foto'), img);
        body.appendChild(photoWrap);
      }

      const readBtn = document.createElement('button');
      readBtn.type = 'button';
      readBtn.className = 'ghost read-toggle';
      const isRead = entry.readBy[state.currentRole];
      readBtn.textContent = isRead ? 'Als ungelesen markieren' : 'Als gelesen markieren';
      readBtn.addEventListener('click', () => toggleRead(entry.id, !isRead));

      body.append(headerLine, topicLine, readBtn);
      node.append(tag, body);
      entryList.appendChild(node);
    });

    const latest = list[0];
    lastUpdate.textContent = 'Letzter Eintrag: ' + formatter.format(latest.createdAt);
  }

  function renderQuestions(){
    questionBox.innerHTML = '';
    if(!state.questions || state.questions.length === 0){
      const placeholder = document.createElement('div');
      placeholder.className = 'subtle';
      placeholder.textContent = 'Noch keine Fragen geladen.';
      questionBox.appendChild(placeholder);
      return;
    }
    state.questions.forEach(q => {
      const node = document.createElement('div');
      node.className = 'question';
      node.textContent = q;
      questionBox.appendChild(node);
    });
  }

  function refreshQuestions(){
    const mood = state.lastMood;
    const pool = questionPool[mood] || questionPool.fallback;
    const shuffled = [...pool].sort(()=>Math.random()-0.5);
    state.questions = shuffled.slice(0,3);
    persist();
    renderQuestions();
  }

  function enrichEntry(entry){
    return {
      readBy: { princess:false, prince:false, ...(entry.readBy || {}) },
      ...entry,
      authorLabel: roles[entry.authorRole]?.label || entry.authorLabel || 'Unbekannt'
    };
  }

  function saveEntry(){
    const mood = state.lastMood || 'ruhig';
    const moodMeta = moods.find(m => m.id === mood) || moods[0];
    const energy = Number(document.getElementById('energy').value) || 5;
    const topic = document.getElementById('topic').value.trim();
    const talkIntent = document.getElementById('talkIntent').value;
    const createdAt = Date.now();

    const entry = {
      id: crypto.randomUUID ? crypto.randomUUID() : `${createdAt}-${Math.random()}`,
      authorRole: state.currentRole,
      authorLabel: roles[state.currentRole].label,
      mood,
      moodLabel: moodMeta.label,
      emoji: moodMeta.emoji,
      energy,
      talkIntent,
      topic,
      createdAt,
      voiceNote: currentVoice,
      photo: currentPhoto,
      readBy: { princess: state.currentRole === 'princess', prince: state.currentRole === 'prince' }
    };

    state.entries.push(entry);
    state.filter = null;
    persist();
    hydrateForm();
    renderEntries();
    renderFilters();
  }

  function toggleRead(id, value){
    state.entries = state.entries.map(entry => {
      if(entry.id !== id) return entry;
      const updated = { ...entry, readBy: { princess:false, prince:false, ...(entry.readBy||{}) } };
      updated.readBy[state.currentRole] = value;
      return updated;
    });
    persist();
    renderEntries();
  }

  async function handlePhotoSelect(evt){
    const file = evt.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      currentPhoto = { data: reader.result, name: file.name, type: file.type };
      renderPhotoPreview();
    };
    reader.readAsDataURL(file);
  }

  function renderPhotoPreview(){
    if(currentPhoto){
      photoPreview.querySelector('img').src = currentPhoto.data;
      photoPreview.hidden = false;
    } else {
      photoPreview.hidden = true;
      photoInput.value = '';
    }
  }

  function renderVoicePreview(){
    if(currentVoice){
      voiceAudio.src = currentVoice.data;
      voicePreview.hidden = false;
      voiceStatus.textContent = 'Sprachnachricht bereit.';
      voiceBtn.textContent = 'Neu aufnehmen';
    } else {
      voicePreview.hidden = true;
      voiceStatus.textContent = 'Bereit zum Aufnehmen.';
      voiceBtn.textContent = 'Aufnahme starten';
    }
  }

  function getPreferredMimeType(){
    if(!supportsMediaRecorder || typeof MediaRecorder.isTypeSupported !== 'function') return null;
    const candidates = ['audio/webm;codecs=opus','audio/webm','audio/mp4','audio/aac'];
    return candidates.find(type => MediaRecorder.isTypeSupported(type)) || null;
  }

  function stopStream(){
    if(activeStream){
      activeStream.getTracks().forEach(t => t.stop());
      activeStream = null;
    }
  }

  async function toggleRecording(){
    if(!supportsMediaRecorder){
      voiceStatus.textContent = 'Auf diesem Ger√§t werden Sprachnachrichten nicht unterst√ºtzt.';
      return;
    }
    if(mediaRecorder && mediaRecorder.state === 'recording'){
      mediaRecorder.stop();
      voiceBtn.textContent = 'Verarbeite...';
      return;
    }
    try{
      activeStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      chunks = [];
      mediaRecorder = new MediaRecorder(activeStream, preferredMimeType ? { mimeType: preferredMimeType } : undefined);
      mediaRecorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
      mediaRecorder.onerror = () => {
        voiceStatus.textContent = 'Aufnahme nicht m√∂glich. Bitte erneut versuchen.';
        stopStream();
      };
      mediaRecorder.onstop = async () => {
        const chosenType = preferredMimeType || (chunks[0]?.type) || 'audio/webm';
        const blob = new Blob(chunks, { type: chosenType });
        const data = await blobToBase64(blob);
        currentVoice = { data, type: blob.type, createdAt: Date.now() };
        renderVoicePreview();
        stopStream();
      };
      mediaRecorder.start();
      voiceStatus.textContent = 'Aufnahme l√§uft ...';
      voiceBtn.textContent = 'Aufnahme stoppen';
    } catch (e){
      voiceStatus.textContent = 'Aufnahme nicht m√∂glich. Bitte Mikrofon erlauben.';
      stopStream();
    }
  }

  function blobToBase64(blob){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }
})();
</script>

<!-- Service Worker Registrierung -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(reg => {
      function readyToActivate(sw) {
        if (sw && sw.state === 'installed') {
          if (navigator.serviceWorker.controller) {
            sw.postMessage({ type: 'SKIP_WAITING' });
          }
        }
      }
      if (reg.waiting) readyToActivate(reg.waiting);
      reg.addEventListener('updatefound', () => {
        const sw = reg.installing;
        sw && sw.addEventListener('statechange', () => readyToActivate(sw));
      });
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        window.location.reload();
      });
    }).catch(console.error);
  });
}
</script>
</body>
</html>
