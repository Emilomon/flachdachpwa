<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rammsondierungsprotokoll (DPL)</title>

  <!-- PWA (Android/General) -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b1020" />

  <!-- PWA (Apple/iOS) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png" />

  <style>
    :root{
      --bg:#0b1020;--panel:#111932;--panel-2:#0d1426;--ink:#e8ecff;--muted:#a8b3d9;--accent:#8aa4ff;--grid:#1d2744;--stroke:#4b5a86;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{display:flex;align-items:center;justify-content:center;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;padding:10px}
    .card{width:min(1180px,98vw);max-height:98vh;background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;display:flex;flex-direction:column;gap:14px;box-shadow:0 12px 40px rgba(0,0,0,.28)}
    header{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;align-items:flex-start}
    h1{margin:0;font-size:clamp(20px,3vw,26px)}
    p{margin:0;color:var(--muted)}
    .eyebrow{font-size:12px;letter-spacing:1px;text-transform:uppercase;color:var(--accent);margin-bottom:4px}
    .badges{display:flex;flex-wrap:wrap;gap:8px}
    .badge{background:var(--panel-2);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:6px 10px;font-variant-numeric:tabular-nums;color:var(--ink)}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:14px;min-height:0;flex:1 1 auto}
    .panel{background:var(--panel-2);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:12px;min-height:0}
    label{font-weight:600;color:var(--ink)}
    textarea{width:100%;min-height:140px;resize:vertical;background:#0b1020;color:var(--ink);border:1px solid var(--stroke);border-radius:10px;padding:10px;font-size:14px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .hint{color:var(--muted);font-size:14px;line-height:1.5}
    button{appearance:none;background:linear-gradient(120deg,#6f86ff,#9bb3ff);border:none;color:#0b1020;font-weight:700;border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer;box-shadow:0 8px 24px rgba(138,164,255,.35);transition:transform .1s ease,box-shadow .1s ease}
    button:active{transform:translateY(1px);box-shadow:0 4px 12px rgba(138,164,255,.35)}
    .ghost{background:transparent;border:1px solid var(--stroke);color:var(--ink);box-shadow:none}
    .grid-inputs{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:6px;max-height:320px;overflow:auto;padding:8px;background:#0b1020;border-radius:10px;border:1px solid var(--stroke)}
    .depth-row{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:4px 6px;background:rgba(255,255,255,.02);border-radius:8px}
    .depth-row label{font-weight:500;font-size:14px;color:var(--muted)}
    .depth-row input{width:90px;padding:6px 8px;border-radius:8px;border:1px solid var(--stroke);background:var(--panel);color:var(--ink);font-size:14px;font-variant-numeric:tabular-nums}
    .chart-wrap{flex:1 1 auto;min-height:0}
    svg{width:100%;height:100%;min-height:520px;display:block;border-radius:12px;background:var(--panel-2)}
    .axis text{fill:var(--muted);font-size:12px}
    .axis line, .grid line{stroke:var(--grid)}
    .grid line{stroke-dasharray:2 4}
    .path-line{fill:none;stroke:var(--accent);stroke-width:3}
    .point{fill:var(--accent)}
    .title{fill:var(--ink);font-size:16px;font-weight:700}
    .legend{font-size:12px;fill:var(--muted)}
    .summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px}
    .summary .badge{display:flex;flex-direction:column;gap:4px}
    .summary strong{font-size:18px;color:var(--ink)}
    @media (max-width:900px){.layout{grid-template-columns:1fr}.grid-inputs{max-height:220px}}
  </style>
</head>
<body>
  <div class="card">
    <header>
      <div>
        <div class="eyebrow">Bodenkennwerte</div>
        <h1>Rammsondierungsprotokoll</h1>
        <p>Trage die Schlagzahlen pro 10&nbsp;cm ein (0&nbsp;m bis 3&nbsp;m). Das Diagramm wird automatisch aktualisiert.</p>
      </div>
      <div class="badges">
        <div class="badge">DIN EN 22476‑2 · DPL</div>
        <div class="badge" id="countBadge">0 / 30 Werte</div>
      </div>
    </header>

    <div class="layout">
      <div class="panel" aria-label="Eingabe">
        <div>
          <label for="inputField">Schlagzahlen (N10) einfügen</label>
          <textarea id="inputField" placeholder="Beispiel: 6 7 9 12 15 18 ..."></textarea>
          <p class="hint">Zahlen werden in der Reihenfolge von 0,1&nbsp;m bis 3,0&nbsp;m gelesen. Trenne Werte mit Leerzeichen, Zeilenumbrüchen oder Kommata.</p>
        </div>
        <div class="grid-inputs" id="depthInputs" aria-label="Tabelle der Schlagzahlen"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button id="sampleBtn" type="button">Beispieldaten laden</button>
          <button id="clearBtn" type="button" class="ghost">Zurücksetzen</button>
        </div>
      </div>

      <div class="panel chart-wrap" aria-label="Diagramm">
        <svg id="chart" role="img" aria-label="Rammsondierungsprotokoll Diagramm"></svg>
        <div class="summary" aria-live="polite">
          <div class="badge"><span>Tiefe</span><strong>0 – 3,0 m</strong></div>
          <div class="badge"><span>Max. Schlagzahl</span><strong id="maxBadge">–</strong></div>
          <div class="badge"><span>Durchschnitt</span><strong id="avgBadge">–</strong></div>
          <div class="badge"><span>Letzter Wert (3,0 m)</span><strong id="lastBadge">–</strong></div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const depthStep = 0.1;
  const depthCount = 30; // 0.1 m bis 3.0 m
  const values = new Array(depthCount).fill(null);

  const textarea = document.getElementById('inputField');
  const grid = document.getElementById('depthInputs');
  const chart = document.getElementById('chart');
  const countBadge = document.getElementById('countBadge');
  const maxBadge = document.getElementById('maxBadge');
  const avgBadge = document.getElementById('avgBadge');
  const lastBadge = document.getElementById('lastBadge');

  function formatNumber(n){ return Number.isFinite(n) ? n.toFixed(0) : '–'; }

  function buildGrid(){
    grid.innerHTML = '';
    for(let i=0;i<depthCount;i++){
      const depth = ((i+1)*depthStep).toFixed(1);
      const row = document.createElement('div');
      row.className = 'depth-row';
      const lab = document.createElement('label');
      lab.textContent = `${depth} m`;
      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.step = '1';
      input.placeholder = '–';
      input.dataset.index = i;
      input.addEventListener('input', () => {
        const v = input.value === '' ? null : Number(input.value);
        values[i] = Number.isFinite(v) ? v : null;
        syncTextarea();
        render();
      });
      row.append(lab, input);
      grid.appendChild(row);
    }
  }

  function syncInputs(){
    const inputs = grid.querySelectorAll('input');
    inputs.forEach(inp => {
      const i = Number(inp.dataset.index);
      inp.value = values[i] ?? '';
    });
  }

  function syncTextarea(){
    const compact = values.map(v => Number.isFinite(v) ? v : '-').join(' ');
    textarea.value = compact;
  }

  function parseTextarea(){
    const raw = textarea.value.trim();
    const parts = raw.split(/[,\s]+/).filter(Boolean);
    for(let i=0;i<depthCount;i++){
      const token = parts[i];
      if(token === undefined || token === '-') { values[i] = null; continue; }
      const num = Number(token);
      values[i] = Number.isFinite(num) ? num : null;
    }
    syncInputs();
    render();
  }

  function loadSample(){
    const sample = [6,7,9,12,15,18,20,22,19,17,14,12,11,12,14,15,17,20,26,31,36,42,48,52,58,62,64,66,66,66];
    sample.forEach((v,i)=>{ values[i]=v; });
    syncInputs();
    syncTextarea();
    render();
  }

  function clearAll(){
    values.fill(null);
    syncInputs();
    syncTextarea();
    render();
  }

  function render(){
    const width = chart.clientWidth || 900;
    const height = chart.clientHeight || 560;
    const margin = {top:36,right:32,bottom:54,left:108};
    const plotW = width - margin.left - margin.right;
    const plotH = height - margin.top - margin.bottom;
    chart.setAttribute('viewBox', `0 0 ${width} ${height}`);
    chart.innerHTML = '';

    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    chart.appendChild(g);

    const maxVal = values.reduce((m,v)=>Number.isFinite(v)?Math.max(m,v):m,0);
    const xMax = Math.max(30, Math.ceil((maxVal+5)/10)*10 || 70);
    const xScale = v => margin.left + (v/xMax)*plotW;
    const yScale = d => margin.top + (d/3)*plotH;

    // Background
    const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
    bg.setAttribute('x', margin.left);
    bg.setAttribute('y', margin.top);
    bg.setAttribute('width', plotW);
    bg.setAttribute('height', plotH);
    bg.setAttribute('fill', '#0b1020');
    bg.setAttribute('stroke', 'rgba(255,255,255,0.04)');
    g.appendChild(bg);

    // Grid horizontal
    const gridG = document.createElementNS('http://www.w3.org/2000/svg','g');
    gridG.setAttribute('class','grid');
    for(let i=0;i<=depthCount;i++){
      const depth = (i*depthStep);
      const y = yScale(depth);
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', margin.left);
      line.setAttribute('x2', width - margin.right);
      line.setAttribute('y1', y);
      line.setAttribute('y2', y);
      gridG.appendChild(line);

      if(i>0 && i%2===0){
        const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
        txt.setAttribute('x', margin.left - 10);
        txt.setAttribute('y', y + 4);
        txt.setAttribute('text-anchor','end');
        txt.textContent = depth.toFixed(1)+' m';
        txt.setAttribute('class','axis');
        gridG.appendChild(txt);
      }
    }
    // Grid vertical
    const stepX = 10;
    for(let x=0; x<=xMax; x+=stepX){
      const vx = xScale(x);
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', vx);
      line.setAttribute('x2', vx);
      line.setAttribute('y1', margin.top);
      line.setAttribute('y2', margin.top + plotH);
      gridG.appendChild(line);

      const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('x', vx);
      txt.setAttribute('y', margin.top + plotH + 18);
      txt.setAttribute('text-anchor','middle');
      txt.textContent = x.toString();
      txt.setAttribute('class','axis');
      gridG.appendChild(txt);
    }
    g.appendChild(gridG);

    // Labels
    const title = document.createElementNS('http://www.w3.org/2000/svg','text');
    title.setAttribute('x', margin.left + plotW/2);
    title.setAttribute('y', 22);
    title.setAttribute('class','title');
    title.setAttribute('text-anchor','middle');
    title.textContent = 'Auswertung: Rammsondierung DPL (Schläge pro 10 cm)';
    g.appendChild(title);

    const axisY = document.createElementNS('http://www.w3.org/2000/svg','text');
    axisY.setAttribute('x', 16);
    axisY.setAttribute('y', margin.top + plotH/2);
    axisY.setAttribute('class','legend');
    axisY.setAttribute('transform', `rotate(-90 16 ${margin.top + plotH/2})`);
    axisY.setAttribute('text-anchor','middle');
    axisY.textContent = 'Tiefe unter Geländeoberkante [m]';
    g.appendChild(axisY);

    const axisX = document.createElementNS('http://www.w3.org/2000/svg','text');
    axisX.setAttribute('x', margin.left + plotW/2);
    axisX.setAttribute('y', height - 10);
    axisX.setAttribute('class','legend');
    axisX.setAttribute('text-anchor','middle');
    axisX.textContent = 'Schläge pro 10 cm (N10)';
    g.appendChild(axisX);

    // Path
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    let d = '';
    let previousValid = false;
    values.forEach((v,idx)=>{
      if(!Number.isFinite(v)) { previousValid=false; return; }
      const depth = (idx+1)*depthStep;
      const x = xScale(v);
      const y = yScale(depth);
      d += previousValid ? ` L ${x} ${y}` : ` M ${x} ${y}`;
      previousValid = true;
    });
    path.setAttribute('d', d || '');
    path.setAttribute('class','path-line');
    g.appendChild(path);

    // Points
    values.forEach((v,idx)=>{
      if(!Number.isFinite(v)) return;
      const depth = (idx+1)*depthStep;
      const cx = xScale(v);
      const cy = yScale(depth);
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx', cx);
      c.setAttribute('cy', cy);
      c.setAttribute('r', 4);
      c.setAttribute('class','point');
      g.appendChild(c);
    });

    // Stats
    const filled = values.filter(v=>Number.isFinite(v));
    const avg = filled.length ? filled.reduce((a,b)=>a+b,0)/filled.length : null;
    countBadge.textContent = `${filled.length} / ${depthCount} Werte`;
    maxBadge.textContent = formatNumber(maxVal || null);
    avgBadge.textContent = formatNumber(avg);
    lastBadge.textContent = formatNumber(values[depthCount-1]);
  }

  textarea.addEventListener('input', parseTextarea);
  document.getElementById('sampleBtn').addEventListener('click', loadSample);
  document.getElementById('clearBtn').addEventListener('click', clearAll);

  buildGrid();
  render();
})();
</script>

<!-- Service Worker Registrierung -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(reg => {
      function readyToActivate(sw) {
        if (sw && sw.state === 'installed') {
          if (navigator.serviceWorker.controller) {
            sw.postMessage({ type: 'SKIP_WAITING' });
          }
        }
      }
      if (reg.waiting) readyToActivate(reg.waiting);
      reg.addEventListener('updatefound', () => {
        const sw = reg.installing;
        sw && sw.addEventListener('statechange', () => readyToActivate(sw));
      });
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        window.location.reload();
      });
    }).catch(console.error);
  });
}
</script>
</body>
</html>
